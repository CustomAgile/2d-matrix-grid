<!DOCTYPE html>
<html>
<head>
    <title>2D Matrix Grid</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(e){var t,n=305419896;for(e=(e=e.replace(/var CHECKSUM = .*;/,"")).replace(/\s/g,""),t=0;t<e.length;t++)n+=e.charCodeAt(t)*t;return n},_checkChecksum:function(e){var t=Ext.create("Deft.Deferred");console.log("_checkChecksum",e);var n=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(e){if(text=e.responseText,CHECKSUM&&CHECKSUM!==n._generateChecksum(text))return console.log("Checksums don't match!"),void t.resolve(!1);t.resolve(!0)}}),t.promise},afterRender:function(){var e=Rally.getApp();e.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(e).then({scope:this,success:function(e){e||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(e){console.log("oops:",e)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}});
                Ext.define("Rally.technicalservices.Logger",{constructor:function(t){Ext.apply(this,t)},log:function(t){var o="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",e=[];e=Ext.Array.push(e,[o]),e=Ext.Array.push(e,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,e)}});
                Ext.define("2d-matrix-grid",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},items:[{xtype:"container",itemId:"message_box",tpl:"Hello, <tpl>{_refObjectName}</tpl>"},{xtype:"container",itemId:"display_box"}],config:{defaultSettings:{modelName:"Defect",xAxisField:"Severity",yAxisField:"Project",xAxisValues:void 0,yAxisValues:void 0,includeXTotal:!0,includeYTotal:!0,gridFilter:"",includeBlanks:!0,sortBy:"total",sortDir:"desc",rowLimit:""}},fieldTypeAttribute:{Project:"Name",Release:"Name",Iteration:"Name",Owner:"UserName",Tags:"_tagsNameArray",Milestones:"_tagsNameArray",Parent:"Name",PortfolioItem:"Name",SubmittedBy:"UserName"},totalText:"Total",launch:function(){var t=this.getSettings();Rally.data.ModelFactory.getModel({type:t.modelName}).then({success:function(t){this.model=t,this._createPivotedStore(this.getSettings())},scope:this})},onTimeboxScopeChange:function(t){this.callParent(arguments),this._createPivotedStore(this.getSettings())},_createPivotedStore:function(t){this.logger.log("_createPivotedStore",t);var e=Ext.create("Rally.technicalservices.data.PivotStoreFactory",{modelName:t.modelName,xAxis:{field:this.getXAxisField(),attributeField:this.getXAxisAttributeField(),values:this.getXAxisValues()},yAxis:{field:this.getYAxisField(),attributeField:this.getYAxisAttributeField(),values:this.getYAxisValues()},includeNone:this.getSetting("includeBlanks"),includeXTotal:this.getSetting("includeXTotal"),includeYTotal:this.getSetting("includeYTotal"),gridFilter:this._getGridFilter(),totalText:this.totalText,sortBy:this.getSetting("sortBy"),sortDir:this.getSetting("sortDir"),rowLimit:this.getSetting("rowLimit")});e.on("load",this._addGrid,this),e.on("error",this._showError,this),e.loadPivotedDataStore()},_getGridFilter:function(){var t=this.getSetting("gridFilter"),e=this.getContext().getTimeboxScope(),i=[];try{i=[Rally.data.wsapi.Filter.fromQueryString(t)]}catch(t){}return e&&e.isApplicable(this.model)&&i.push(e.getQueryFilter()),_.compact(i)},_showError:function(t){this.logger.log("_showError",t)},getXAxisField:function(){return this.getSetting("xAxisField")},getYAxisField:function(){return this.getSetting("yAxisField")},getXAxisValues:function(){return this.getArraySettings("xAxisValues")},getYAxisValues:function(){return this.getArraySettings("yAxisValues")},getArraySettings:function(t){var e=this.getSetting(t);return e?Ext.isString(e)?e.split(","):e:[]},getXAxisAttributeField:function(){if("State"===this.getXAxisField()&&new RegExp("^PortfolioItem","i").test(this.getSetting("modelName")))return"Name";return this.fieldTypeAttribute[this.getXAxisField()]||null},getYAxisAttributeField:function(){if("State"===this.getYAxisField()&&new RegExp("^PortfolioItem","i").test(this.getSetting("modelName")))return"Name";return this.fieldTypeAttribute[this.getYAxisField()]||null},_addGrid:function(t,e){this.logger.log("_addGrid",t,e),this.down("rallygrid")&&this.down("rallygrid").destroy(),this.add({xtype:"rallygrid",store:t,columnCfgs:this._getColumns(e),showPagingToolbar:!1,showRowActionsColumn:!1})},_getColumnDataIndex:function(t){return t.replace(/\./g,"[dot]").replace(/\"/g,"[quote]")},_getColumns:function(t){var e=[],i=this.getYAxisField(),s=this.totalText;return _.each(t,function(t){var r="right",l=2;t===i&&(r="left",l=3),t===s&&(l=1),e.push({text:t,dataIndex:this._getColumnDataIndex(t),align:r,flex:l,renderer:function(e,r,l){return l.get(i)!==s&&t!==s||(r.tdCls="totalCls"),e}})},this),this.logger.log("_getColumns",e),e},isExternal:function(){return void 0===this.getAppId()},getSettingsFields:function(){return Rally.technicalservices.TwoDGridSettings.getFields(this.getSettings())},onSettingsUpdate:function(t){this.logger.log("onSettingsUpdate",t),Ext.apply(this,t),this._createPivotedStore(t)}});
                Ext.define("Rally.technicalservices.MultiValueComboBox",{alias:"widget.multivaluecombo",extend:"Ext.form.FieldContainer",mixins:{field:"Ext.form.field.Field"},cls:"multistate",config:{fieldLabel:"",modelName:void 0,fieldName:void 0,value:void 0},refreshField:function(e){this.fieldName=e,this._initCombobox()},setModel:function(e){this.fieldName="",this.modelName=e,this._initCombobox()},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this),this._initCombobox()},_initCombobox:function(){this.down("rallycombobox")&&this.down("rallycombobox").destroy(),this.down("rallytagpicker")&&this.down("rallytagpicker").destroy();"Tags"!==this.fieldName?this._addMultiValueComboBox():this.add({xtype:"rallytagpicker"})},_addMultiValueComboBox:function(){var e=this;this.add([{xtype:"rallycombobox",name:"valField",plugins:["rallyfieldvalidationui"],multiSelect:!0,emptyText:this.emptyText,displayField:"name",valueField:"value",width:this.width,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]},listeners:{change:function(i,t,l){e.currentValue=t}}}]),this.modelName&&this.fieldName&&this._loadValues()},_loadValues:function(){console.log("_loadValues",this.modelName,this.fieldName),Rally.technicalservices.WsapiToolbox.fetchAllowedValues(this.modelName,this.fieldName).then({scope:this,success:function(e){var i=Ext.Array.map(e,function(e){return{name:e||"None",value:e}}),t=this.down("rallycombobox");t.getStore().loadData(i);var l=this.getValue();console.log("current values:",l),l&&!Ext.isArray(l)&&(l=l.split(",")),t.setValue(l),this.fireEvent("ready",this)},failure:function(e){Ext.Msg.alert("Problem Retrieving States",e)}})},getSubmitData:function(){var e={};if(this.down("rallytagpicker")){var i=[];_.each(this.down("rallytagpicker").getValue(),function(e){i.push(e.get("Name"))}),e[this.name]=i}else e[this.name]=this.currentValue;return e}});
                Ext.override(Rally.ui.combobox.FieldComboBox,{blackListFields:[],whiteListFields:[],allowedTypes:[],constrained:!0,constructor:function(i){return this.blackListFields=i.blackListFields||[],this.whiteListFields=i.whiteListFields||[],this.allowedTypes=i.allowedTypes||[],this.constrained=i.constrained||!1,this.mergeConfig(i),this.store=Ext.create("Ext.data.Store",{fields:[this.valueField,this.displayField,"fieldDefinition"],data:[]}),this.callParent([this.config])},_populateStore:function(){if(this.store){var i=_.sortBy(_.map(_.filter(this.model.getFields(),this._isNotHidden,this),this._convertFieldToLabelValuePair,this),"name");this.store.loadRawData(i),this.setDefaultValue(),this.onReady()}},_isNotHidden:function(i){console.log("_isNotHidden",i,this.allowedTypes);var t=!1;return!i.hidden&&i.attributeDefinition&&(Ext.Array.contains(this.allowedTypes,i.attributeDefinition.AttributeType)&&(t=!0),Ext.Array.contains(this.blackListFields,i.name)&&(t=!1),!0===this.constrained&&!0!==i.attributeDefinition.Constrained&&(t=!1),Ext.Array.contains(this.whiteListFields,i.name)&&(t=!0)),t}});
                Ext.define("Rally.technicalservices.data.PivotStoreFactory",{mixins:{observable:"Ext.util.Observable"},logger:new Rally.technicalservices.Logger,xAxis:{field:void 0,attributeField:void 0,values:void 0},yAxis:{field:void 0,attributeField:void 0,values:void 0},noneText:"-- No Entry --",totalField:"total",totalText:"Total",includeXTotal:!0,includeYTotal:!0,includeNone:!0,constructor:function(t){Ext.apply(this,t),this.logger.log("Pivot constructor",this,t),this.mixins.observable.constructor.call(this,t)},getFetchFields:function(){var t=this.xAxis&&this.xAxis.field||null,e=this.yAxis&&this.yAxis.field||null,i=[];return this.xAxis&&this.xAxis.attributeField&&i.push(this.xAxis.attributeField),this.yAxis&&this.yAxis.attributeField&&i.push(this.yAxis.attributeField),[t,e].concat(i)},getFilters:function(){return this.gridFilter||[]},getSorters:function(t){var e=this.xAxis&&this.xAxis.field;return e&&this.xAxis.attributeField&&(e=e+"."+this.xAxis.attributeField),[{property:e,direction:t||"ASC"}]},fetchXAxisFields:function(){var t=Ext.create("Deft.Deferred"),e=this.modelName,i=this.xAxis.field,s=this.noneText,a=this.includeNone,o=this.includeXTotal,r=this.totalText,l=this.xAxis.values||[];return Rally.data.ModelFactory.getModel({type:e,success:function(e){e.getField(i).getAllowedValueStore().load({callback:function(e,i,n){var c=[];_.each(e,function(t){var e=t.get("StringValue");e&&(Ext.Array.contains(l,e)||0===l.length)&&c.push(e)},this),a&&c.push(s),o&&c.push(r),t.resolve(c)}})},scope:this}),t},fetchRecords:function(){var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:this.modelName,fetch:this.getFetchFields(),filters:this.getFilters(),limit:"Infinity",sorters:this.getSorters(),pageSize:2e3,listeners:{beforeload:function(){}}}).load({callback:function(e,i,s){this.logger.log("fetchRecords load",e,i,s);this.getCollectionField();t.resolve(e)},scope:this})},fetchCollectionValues:function(t,e){var i=Ext.create("Deft.Deferred"),s=this,a=[];return _.each(t,function(t){t.get(e)&&t.get(e).Count>0?a.push(this.fetchCollection(t,e)):t.set(e+"Array",[])},this),a.length>0?Deft.Promise.all(a).then({success:function(){s.logger.log("fetchCollectionValues",t),i.resolve(t)}}):i.resolve(t),i},fetchCollection:function(t,e){var i=Ext.create("Deft.Deferred");return t.getCollection(e).load({callback:function(s,a,o){var r=[];_.each(s,function(t){r.push(t.get("Name"))}),t.set(e+"Array",r),console.log("record.set",e,r,t),i.resolve()}}),i},getCollectionField:function(){return"Tags"===this.yAxis.field?"Tags":null},loadPivotedDataStore:function(){Deft.Promise.all([this.fetchRecords(),this.fetchXAxisFields()]).then({success:function(t){this.logger.log("loadPivotedDataStore success",t);var e=t[0],i=t[1],s=[this.yAxis.field],a=this.getPivotedDataStore(e,i);this.fireEvent("load",a,s.concat(i))},failure:function(t){this.fireEvent("error",t)},scope:this})},_initializeDataHash:function(t,e,i,s){var a={},o=this.yAxis.field;return _.each(t,function(t){a[t]=this._initializeRow(o,t,e,i)},this),this.logger.log("_inititalizeDataHash",a),a},getPivotedDataStore:function(t,e){this.logger.log("getPivotedDataStore",e);var i=this.xAxis,s=this.yAxis,a=i&&i.field,o=s&&s.field,r=i&&i.attributeField,l=s&&s.attributeField,n=[o].concat(e),c=this.includeYTotal,h=this.includeXTotal,u=e,d=this.yAxis.values||[],f=this.totalText,g=this._initializeRow(o,f,e,h),x=this._initializeDataHash(d,u,h,c);_.each(t,function(t){var i=r&&t.get(a)?t.get(a)[r]:t.get(a)||this.noneText,s=l&&t.get(o)?t.get(o)[l]:t.get(o)||this.noneText;i&&0!==i.length||(i=this.noneText);var n=[];"_tagsNameArray"===l?(n=_.map(s,function(t){return t.Name}),d.length>0&&(n=Ext.Array.intersect(n,d))):(Ext.Array.contains(d,s)||0===d.length)&&n.push(s),_.each(n,function(t){x[t]||(x[t]=this._initializeRow(o,t,e,h)),(Ext.Array.contains(u,i)||0===u.length)&&(x[t][i]=x[t][i]+1,h&&(x[t][f]=x[t][f]+1),c&&(g[i]=g[i]+1,g[f]=g[f]+1))},this)},this),c&&(x[this.totalText]=g);var v=o;"total"===this.sortBy&&(v=this.totalText);var A=this._getSortedData(x,v,this.sortDir,this.rowLimit,this.totalText,o),y=this,p=_.map(n,function(t){return{name:y._getFieldName(t),mapping:!1,convert:function(t,e){return e.raw[y._getDataName(this.name)]}}});return Ext.create("Rally.data.custom.Store",{fields:p,data:A,remoteSort:!1,pageSize:A.length})},_getFieldName:function(t){return t.replace(/\./g,"[dot]").replace(/\"/g,"[quote]")},_getDataName:function(t){return t.replace(/\[dot\]/g,".").replace(/\[quote\]/g,'"')},_getSortedData:function(t,e,i,s,a,o){var r=t[a];delete t[a];var l=_.values(t),n="asc"===i.toLowerCase()?-1:1,c=Ext.Array.sort(l,function(t,i){return i[o]===a?-1:t[e]<i[e]?n:t[e]>i[e]?-1*n:0});if(c.push(r),s&&s>0){var h=Ext.Array.slice(c,0,s);if(s<c.length&&t[a]){var u={};u[o]=a,_.each(h,function(t){_.each(t,function(t,e){e!==o&&(u[e]=(u[e]||0)+t)})}),h.push(u)}return h}return c},_initializeRow:function(t,e,i,s){var a={};return a[t]=e,s&&(a.total=0),_.each(i,function(t){a[t]=0}),a}});
                Ext.define("Rally.technicalservices.TwoDGridSettings",{singleton:!0,getFields:function(e){var l=e.sortBy||"alpha",a=e.sortDir||"desc";return[{xtype:"rallycombobox",name:"modelName",fieldLabel:"Artifact Type",labelWidth:150,labelAlign:"right",bubbleEvents:["change"],valueField:"TypePath",value:e.modelName,storeConfig:{model:"TypeDefinition",remoteSort:!0,remoteFilter:!0,filters:[{property:"Creatable",value:!0},{property:"Deletable",value:!0},{property:"Restorable",value:!0},{property:"Name",operator:"!=",value:"Milestone"}]}},{xtype:"rallyfieldcombobox",model:e.modelName,name:"xAxisField",fieldLabel:"X Axis Field",labelWidth:150,labelAlign:"right",blackListFields:[],whiteListFields:["Release","Iteration","ScheduleState","State"],allowedTypes:["STRING","RATING"],constrained:!0,bubbleEvents:["change"],value:e.xAxisField,handlesEvents:{change:function(e){"modelName"===e.name&&this.refreshWithNewModelType(e.getRecord().get("TypePath"))}}},{name:"xAxisValues",xtype:"multivaluecombo",readyEvent:"ready",labelWidth:150,labelAlign:"right",width:500,modelName:e.modelName,fieldName:null,emptyText:"Choose field values to limit columns or leave blank to show all values...",fieldLabel:"X Axis Values",handlesEvents:{change:function(e){"modelName"===e.name&&this.setModel(e.getRecord().get("TypePath")),"xAxisField"===e.name&&(this.refreshField(e.getValue()),this.currentValue="")}}},{xtype:"rallyfieldcombobox",model:e.modelName,name:"yAxisField",labelAlign:"right",fieldLabel:"Y Axis Field",labelWidth:150,blackListFields:[],whiteListFields:["Release","Iteration","Project","ScheduleState","State","Owner","SubmittedBy","Tags","Parent","PortfolioItem","Milestones"],allowedTypes:["STRING","RATING"],constrained:!0,bubbleEvents:["change"],value:e.yAxisField,handlesEvents:{change:function(e){"modelName"===e.name&&this.refreshWithNewModelType(e.getRecord().get("TypePath"))}}},{name:"yAxisValues",xtype:"multivaluecombo",readyEvent:"ready",labelWidth:150,labelAlign:"right",width:500,modelName:e.modelName,fieldName:null,fieldLabel:"Y Axis Values",emptyText:"Choose field values to limit rows or leave blank to show all values...",handlesEvents:{change:function(e){"modelName"===e.name&&this.setModel(e.getRecord().get("TypePath")),"yAxisField"===e.name&&(this.refreshField(e.getValue()),this.currentValue="")}}},{xtype:"rallycheckboxfield",fieldLabel:"Include Blanks",value:e.includeBlanks,name:"includeBlanks",labelAlign:"right",labelWidth:150},{xtype:"rallycheckboxfield",fieldLabel:"Include Row Totals",value:e.includeXTotal,name:"includeXTotal",labelAlign:"right",labelWidth:150},{xtype:"rallycheckboxfield",fieldLabel:"Include Column Totals",value:e.includeYTotal,name:"includeYTotal",labelAlign:"right",labelWidth:150},{xtype:"radiogroup",fieldLabel:"Sort By",columns:1,vertical:!0,labelWidth:150,labelAlign:"right",items:[{boxLabel:"Alphabetical",name:"sortBy",inputValue:"alpha",checked:"alpha"===l},{boxLabel:"Total",name:"sortBy",inputValue:"total",checked:"total"===l}]},{xtype:"radiogroup",fieldLabel:"Sort Direction",columns:1,vertical:!0,labelWidth:150,labelAlign:"right",items:[{boxLabel:"Descending",name:"sortDir",inputValue:"desc",checked:"desc"===a},{boxLabel:"Ascending",name:"sortDir",inputValue:"asc",checked:"asc"===a}]},{xtype:"rallynumberfield",fieldLabel:"Total Rows to Display (Blank for no limit)",name:"rowLimit",labelWidth:150,labelAlign:"right",minValue:1,allowBlank:!0,value:e.rowLimit},{xtype:"textarea",fieldLabel:"Query",name:"gridFilter",anchor:"100%",cls:"query-field",margin:"0 70 0 0",labelAlign:"right",labelWidth:150,plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(e){try{return e&&Rally.data.wsapi.Filter.fromQueryString(e),!0}catch(e){return e.message}}}]}});
                Ext.define("Rally.technicalservices.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(e,t){var r=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:e,fetch:["ObjectID"],filters:t,limit:1,pageSize:1}).load({callback:function(a,l,o){o?r.resolve(l.resultSet.totalRecords):r.reject(Ext.String.format("Error getting {0} count for {1}: {2}",e,t.toString(),l.error.errors.join(",")))}}),r},fetchWsapiRecords:function(e,t,r){var a=Ext.create("Deft.Deferred");Ext.create("Rally.data.wsapi.Store",{model:e,fetch:r,filters:t,limit:1/0}).load({callback:function(r,l,o){o?a.resolve(r):a.reject(Ext.String.format("Error getting {0} for {1}: {2}",e,t.toString(),l.error.errors.join(",")))}});return a},fetchReleases:function(e){var t=Ext.create("Deft.Deferred"),r=e.getRecord();return null==r&&t.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:r.get("Name")},{property:"ReleaseStartDate",value:r.get("ReleaseStartDate")},{property:"ReleaseDate",value:r.get("ReleaseDate")}],limit:1/0}).load({callback:function(e,r,a){a?t.resolve(e):t.reject("Error loading Releases: "+r.error.errors.join(","))}}),t},fetchAllowedValues:function(e,t){var r=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:e,success:function(e){e.getField(t).getAllowedValueStore().load({callback:function(e,t,a){var l=Ext.Array.map(e,function(e){return e.get("StringValue")});r.resolve(l)}})},failure:function(e){r.reject("Error loading field values: "+e)}}),r}});

            Rally.launchApp('2d-matrix-grid', {
                name:"2D Matrix Grid",
                parentRepos:"",
                version:"0.2.6"
            });

        });
    </script>


    <style type="text/css">
        .tsinfolink{position:absolute;right:0px;width:14px;height:14px;border-radius:7px;text-align:center;color:white;background:#C0C0C0;border-style:solid;border-width:1px;margin-top:25px;margin-right:5px;cursor:pointer}.totalCls{font-weight:bold;color:#666666;font-style:italic}
    </style>
</head>
<body>
</body>
</html>
